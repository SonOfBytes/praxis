#!/bin/sh

# git tag $(VERSION)
# git push origin refs/tags/$(VERSION)
# @echo "release: $(VERSION)"

set -e

die() { echo $*; exit 1; }

source "$(dirname $0)/github"

# merge() {
#   local pr=$1
#   local base=$(git rev-parse --abbrev-ref HEAD)
#   local remote="https://github.com/$(gethub /repos/convox/rack/pulls/$1 ".head.repo.full_name")"
#   local ref=$(gethub /repos/convox/rack/pulls/$1 ".head.ref")
#   local work="merge-${ref}"

#   git branch -D $work >/dev/null 2>&1 || true
#   git fetch $remote $ref:$work
#   git checkout $work
#   git rebase $base || (git rebase --abort; git checkout $base; die "could not rebase: $pr")
#   git checkout $base
#   git merge --no-ff --no-edit -m "[merge] pull request #$pr" $work
#   git branch -d $work
# }

git tag $VERSION
git push origin refs/tags/$VERSION

posthub "/repos/convox/praxis/releases" "{\"tag_name\":\"$VERSION\",\"name\":\"$VERSION\",\"prerelease\":true}"

# echo "milestone: $milestone"

# mid=$(posthub /repos/convox/rack/milestones "{\"title\":\"$milestone\"}" ".number")

# gethub '/repos/convox/rack/issues' ".[]|select(.pull_request)|.number" "labels=status/6-merge" | while read pr; do
#   echo "adding to milestone: $pr"
#   patchhub "/repos/convox/rack/issues/$pr" "{\"milestone\":$mid}" >/dev/null
# done
